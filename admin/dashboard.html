<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio CMS - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            line-height: 1.6;
        }

        .header {
            background: white;
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            font-size: 24px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #666;
            font-size: 14px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .main-content {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .stat-card .change {
            font-size: 12px;
            color: #666;
        }

        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .actions-left {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 8px 16px 8px 40px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            width: 300px;
        }

        .search-box::before {
            content: "üîç";
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .project-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .project-image {
            width: 100%;
            height: 200px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 14px;
            background-size: cover;
            background-position: center;
        }

        .project-content {
            padding: 1.5rem;
        }

        .project-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .project-description {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .project-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 12px;
            color: #666;
        }

        .project-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #666;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 1rem;
            color: #333;
        }

        .empty-state p {
            margin-bottom: 2rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-header h3 {
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert.error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
        }

        .alert.success {
            background: #efe;
            border: 1px solid #cfc;
            color: #363;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .loading.show {
            display: block;
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .main-content {
                padding: 1rem;
            }

            .actions-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box input {
                width: 100%;
            }

            .projects-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Portfolio CMS Dashboard</h1>
        <div class="header-actions">
            <div class="user-info">
                <span>üë§</span>
                <span id="currentUser">Loading...</span>
            </div>
            <a href="/" class="btn btn-secondary" target="_blank">üì± View Portfolio</a>
            <button id="logoutBtn" class="btn btn-danger">üö™ Logout</button>
        </div>
    </div>

    <div class="main-content">
        <div id="alert" class="alert"></div>
        <div id="loading" class="loading">
            <p>Loading dashboard...</p>
        </div>

        <div id="dashboardContent" style="display: none;">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Projects</h3>
                    <div class="value" id="totalProjects">0</div>
                    <div class="change">Active projects in portfolio</div>
                </div>
                <div class="stat-card">
                    <h3>Latest Project</h3>
                    <div class="value" id="latestProject">None</div>
                    <div class="change" id="latestProjectDate">No projects yet</div>
                </div>
                <div class="stat-card">
                    <h3>Storage Used</h3>
                    <div class="value" id="storageUsed">0 MB</div>
                    <div class="change">Images and videos</div>
                </div>
            </div>

            <!-- Actions Bar -->
            <div class="actions-bar">
                <div class="actions-left">
                    <a href="/admin/editor" class="btn btn-primary">
                        ‚ûï New Project
                    </a>
                    <button id="importBtn" class="btn btn-secondary">
                        üì• Import
                    </button>
                    <button id="exportBtn" class="btn btn-secondary">
                        üì§ Export
                    </button>
                    <button id="bulkDeleteBtn" class="btn btn-danger" style="display: none;">
                        üóëÔ∏è Delete Selected
                    </button>
                </div>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search projects...">
                </div>
            </div>

            <!-- Projects Grid -->
            <div id="projectsContainer">
                <div id="projectsGrid" class="projects-grid"></div>
                <div id="emptyState" class="empty-state" style="display: none;">
                    <h3>No Projects Yet</h3>
                    <p>Start building your portfolio by creating your first project</p>
                    <a href="/admin/editor" class="btn btn-primary">Create First Project</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Delete</h3>
                <button class="close-btn" onclick="closeModal('deleteModal')">&times;</button>
            </div>
            <p>Are you sure you want to delete this project? This action cannot be undone.</p>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="btn btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
                <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <script>
        class Dashboard {
            constructor() {
                this.projects = [];
                this.filteredProjects = [];
                this.selectedProjects = new Set();
                
                this.init();
            }

            async init() {
                try {
                    await this.checkAuth();
                    await this.loadProjects();
                    this.setupEventListeners();
                    this.showDashboard();
                } catch (error) {
                    console.error('Dashboard initialization failed:', error);
                    this.showAlert('Failed to load dashboard', 'error');
                }
            }

            async checkAuth() {
                const response = await fetch('/api/auth/status');
                const data = await response.json();
                
                if (!data.authenticated) {
                    window.location.href = '/admin';
                    return;
                }
                
                document.getElementById('currentUser').textContent = data.admin.username;
            }

            async loadProjects() {
                try {
                    const response = await fetch('/api/projects');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.projects = data.data;
                        this.filteredProjects = [...this.projects];
                        this.updateStats();
                        this.renderProjects();
                    } else {
                        throw new Error(data.message);
                    }
                } catch (error) {
                    console.error('Failed to load projects:', error);
                    this.showAlert('Failed to load projects', 'error');
                }
            }

            updateStats() {
                document.getElementById('totalProjects').textContent = this.projects.length;
                
                if (this.projects.length > 0) {
                    const latest = this.projects[0];
                    document.getElementById('latestProject').textContent = latest.title;
                    document.getElementById('latestProjectDate').textContent = 
                        `Created ${new Date(latest.created_at).toLocaleDateString()}`;
                } else {
                    document.getElementById('latestProject').textContent = 'None';
                    document.getElementById('latestProjectDate').textContent = 'No projects yet';
                }
                
                // TODO: Calculate actual storage usage
                document.getElementById('storageUsed').textContent = '0 MB';
            }

            renderProjects() {
                const grid = document.getElementById('projectsGrid');
                const emptyState = document.getElementById('emptyState');
                
                if (this.filteredProjects.length === 0) {
                    grid.innerHTML = '';
                    emptyState.style.display = 'block';
                    return;
                }
                
                emptyState.style.display = 'none';
                
                grid.innerHTML = this.filteredProjects.map(project => `
                    <div class="project-card" data-project-id="${project.id}">
                        <div class="project-image" ${project.image_url ? `style="background-image: url('${project.image_url}')"` : ''}>
                            ${!project.image_url ? 'üì∑ No image' : ''}
                        </div>
                        <div class="project-content">
                            <div class="project-title">${this.escapeHtml(project.title)}</div>
                            <div class="project-description">${this.escapeHtml(project.description || 'No description')}</div>
                            <div class="project-meta">
                                <span>Created: ${new Date(project.created_at).toLocaleDateString()}</span>
                                <span>${project.links ? project.links.length : 0} links</span>
                            </div>
                            <div class="project-actions">
                                <a href="/admin/editor?id=${project.id}" class="btn btn-primary btn-small">‚úèÔ∏è Edit</a>
                                <button onclick="dashboard.duplicateProject(${project.id})" class="btn btn-secondary btn-small">üìã Duplicate</button>
                                <button onclick="dashboard.deleteProject(${project.id})" class="btn btn-danger btn-small">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            setupEventListeners() {
                // Search functionality
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.filterProjects(e.target.value);
                });

                // Logout
                document.getElementById('logoutBtn').addEventListener('click', this.logout.bind(this));

                // Export
                document.getElementById('exportBtn').addEventListener('click', this.exportProjects.bind(this));

                // Import
                document.getElementById('importBtn').addEventListener('click', this.importProjects.bind(this));
            }

            filterProjects(searchTerm) {
                const term = searchTerm.toLowerCase().trim();
                
                if (!term) {
                    this.filteredProjects = [...this.projects];
                } else {
                    this.filteredProjects = this.projects.filter(project =>
                        project.title.toLowerCase().includes(term) ||
                        (project.description && project.description.toLowerCase().includes(term))
                    );
                }
                
                this.renderProjects();
            }

            async deleteProject(id) {
                this.projectToDelete = id;
                document.getElementById('deleteModal').classList.add('show');
                
                document.getElementById('confirmDeleteBtn').onclick = async () => {
                    try {
                        const response = await fetch(`/api/projects/${id}`, {
                            method: 'DELETE'
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            this.showAlert('Project deleted successfully', 'success');
                            await this.loadProjects();
                        } else {
                            this.showAlert(data.message || 'Failed to delete project', 'error');
                        }
                    } catch (error) {
                        console.error('Delete failed:', error);
                        this.showAlert('Failed to delete project', 'error');
                    }
                    
                    this.closeModal('deleteModal');
                };
            }

            async duplicateProject(id) {
                try {
                    const project = this.projects.find(p => p.id === id);
                    if (!project) return;

                    const duplicatedProject = {
                        ...project,
                        title: `${project.title} (Copy)`,
                        id: undefined,
                        created_at: undefined,
                        updated_at: undefined
                    };

                    const response = await fetch('/api/projects', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(duplicatedProject)
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.showAlert('Project duplicated successfully', 'success');
                        await this.loadProjects();
                    } else {
                        this.showAlert(data.message || 'Failed to duplicate project', 'error');
                    }
                } catch (error) {
                    console.error('Duplication failed:', error);
                    this.showAlert('Failed to duplicate project', 'error');
                }
            }

            async exportProjects() {
                try {
                    const response = await fetch('/api/projects/export/json');
                    const projects = await response.json();
                    
                    const blob = new Blob([JSON.stringify(projects, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `portfolio-projects-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    this.showAlert('Projects exported successfully', 'success');
                } catch (error) {
                    console.error('Export failed:', error);
                    this.showAlert('Failed to export projects', 'error');
                }
            }

            importProjects() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        const text = await file.text();
                        const projects = JSON.parse(text);

                        const response = await fetch('/api/projects/import/json', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ projects, overwrite: false })
                        });

                        const data = await response.json();

                        if (data.success) {
                            this.showAlert(`Successfully imported ${data.importedCount} projects`, 'success');
                            await this.loadProjects();
                        } else {
                            this.showAlert(data.message || 'Failed to import projects', 'error');
                        }
                    } catch (error) {
                        console.error('Import failed:', error);
                        this.showAlert('Failed to import projects. Please check the file format.', 'error');
                    }
                };
                input.click();
            }

            async logout() {
                try {
                    const response = await fetch('/api/auth/logout', { method: 'POST' });
                    const data = await response.json();
                    
                    if (data.success) {
                        window.location.href = '/admin';
                    }
                } catch (error) {
                    console.error('Logout failed:', error);
                }
            }

            showDashboard() {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('dashboardContent').style.display = 'block';
            }

            showAlert(message, type = 'info') {
                const alert = document.getElementById('alert');
                alert.textContent = message;
                alert.className = `alert ${type} show`;
                
                setTimeout(() => {
                    alert.classList.remove('show');
                }, 5000);
            }

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('show');
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Global functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Initialize dashboard
        let dashboard;
        document.addEventListener('DOMContentLoaded', () => {
            dashboard = new Dashboard();
        });
    </script>
</body>
</html>